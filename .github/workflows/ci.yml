# .github/workflows/ci.yml
name: Frontend CI

on:
  pull_request:
    branches:
      - dev
      - release
      - main

jobs:
  # 1) Unit Tests: *-feat-* â†’ dev  /  hotfix/* â†’ main
  unit-tests:
    name: ðŸ”¨ Unit Tests
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'pull_request'
      && (
        github.base_ref == 'dev'  && contains(github.head_ref, '-feat-')
        || github.base_ref == 'main' && startsWith(github.head_ref, 'hotfix/')
      )
    steps:
      - uses: actions/checkout@v3
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'
      - name: Install dependencies
        run: npm ci
      - name: Run Unit (Build) Test
        run: npm run test:unit

  # 2) Integration Tests: dev â†’ release  /  release/* â†’ main  /  hotfix/* â†’ main  /  main â†’ dev
  integration-tests:
    name: ðŸ”— Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    if: >
      github.event_name == 'pull_request'
      && (
        github.base_ref == 'release' && github.head_ref == 'dev'
        || github.base_ref == 'main'    && startsWith(github.head_ref, 'release/')
        || github.base_ref == 'main'    && startsWith(github.head_ref, 'hotfix/')
        || github.base_ref == 'dev'     && github.head_ref == 'main'
      )
    services:
      mysql:
        image: mysql:8
        env:
          MYSQL_ROOT_PASSWORD: ${{ secrets.DB_ROOT_PASSWORD }}
          MYSQL_DATABASE: community_db
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping --silent"
          --health-interval=10s --health-retries=3
    env:
      BACKEND_PORT: 8080
      FRONTEND_PORT: 4173
    steps:
      - uses: actions/checkout@v3

      - name: Checkout Backend for Integration
        uses: actions/checkout@v3
        with:
          repository: 100-hours-a-week/9_meow_be
          token: ${{ secrets.GITHUB_TOKEN }}
          path: backend

      - name: Start Backend with DB
        run: |
          cd backend
          mvn clean package -DskipTests
          java -jar target/*.jar &

      - name: Wait for Backend Health
        run: |
          for i in {1..12}; do
            curl -sf http://localhost:$BACKEND_PORT/api/health && break
            sleep 5
          done

      - name: Build & Preview Frontend
        run: |
          npm run build
          npm run preview &

      - name: Wait for Frontend Ready
        run: |
          for i in {1..6}; do
            curl -sf http://localhost:$FRONTEND_PORT/ && break
            sleep 5
          done

      - name: Check Backend API via Frontend
        run: curl -f http://localhost:$FRONTEND_PORT/api/health

      - name: Check Tone Conversion via Backend
        run: curl -f "http://localhost:$FRONTEND_PORT/api/infer?text=hi&type=cat"
